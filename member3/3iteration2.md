# 成员3 - 第2次迭代报告

## 一、任务概述
- **模块**：DM.v (数据存储器)
- **目标**：实现字节/半字/字访存指令（LB/LBU/LH/LHU/SB/SH）
- **选择原因**：访存扩展是MEM阶段核心功能，需在流水线集成前完成

## 二、完成的任务

### 2.1 模块实现
- **文件位置**：`src/lab_4/DM.v`
- **功能描述**：支持MIPS五种访存模式的数据存储器

### 2.2 核心代码
```verilog
// MemOp编码:
// 000: LW/SW (字)
// 001: SH (半字存储)
// 010: SB (字节存储)
// 100: LH (半字符号扩展)
// 101: LHU (半字零扩展)
// 110: LB (字节符号扩展)
// 111: LBU (字节零扩展)

// 字节写使能逻辑
assign byte_we = (mem_op_i == 3'b000) ? 4'b1111 :
                 (mem_op_i == 3'b001 ||
                  mem_op_i == 3'b100 ||
                  mem_op_i == 3'b101) ?
                   (addr_i[1] ? 4'b1100 : 4'b0011) :
                 (mem_op_i == 3'b010 ||
                  mem_op_i == 3'b110 ||
                  mem_op_i == 3'b111) ?
                   (4'b0001 << addr_i[1:0]) :
                 4'b0000;
```

### 2.3 Testbench实现
- **文件位置**：`sim/dm_test.cpp`
- **编译方式**：Verilator

## 三、测试结果

### 3.1 测试环境
- **仿真工具**：Verilator 5.002
- **操作系统**：Linux
- **测试日期**：2025-01-22

### 3.2 测试用例

| 序号 | 测试内容 | 预期值 | 实际值 | 结果 |
|------|----------|--------|--------|------|
| 1 | SW/LW 字存储加载 | 0x12345678 | 0x12345678 | ✅ PASS |
| 2 | SB 字节存储 | 0x000000DD | 0x000000DD | ✅ PASS |
| 3 | LB 符号扩展(MSB=1) | 0xFFFFFFDD | 0xFFFFFFDD | ✅ PASS |
| 4 | LB 负数符号扩展 | 0xFFFFFF80 | 0xFFFFFF80 | ✅ PASS |
| 5 | LBU 零扩展 | 0x00000080 | 0x00000080 | ✅ PASS |
| 6 | SH 存储低16位 | 0x00001234 | 0x00001234 | ✅ PASS |
| 7 | LH 正数符号扩展 | 0x00001234 | 0x00001234 | ✅ PASS |
| 8 | LH 负数符号扩展 | 0xFFFF8000 | 0xFFFF8000 | ✅ PASS |
| 9 | SH 高16位存储 | 0x0000ABCD | 0x0000ABCD | ✅ PASS |
| 10 | 字边界对齐测试 | 0xDEADBEEF | 0xDEADBEEF | ✅ PASS |
| 11 | LBU 零扩展验证 | 0x000000DD | 0x000000DD | ✅ PASS |

### 3.3 测试输出
```
========================================
  DM Module Test (Verilator)
========================================

  Total:  11
  Passed: 11
  Failed: 0
  ALL TESTS PASSED!
```

### 3.4 波形文件
- **位置**：`obj_dir/dm_waveform.vcd`
- **查看方式**：`gtkwave obj_dir/dm_waveform.vcd`

## 四、调试记录

### 4.1 遇到的问题

**问题1：MemOp编码混淆**
- **现象**：测试用例与模块编码不匹配
- **解决**：确认7种MemOp编码，重新设计测试用例

**问题2：SH存储预期值错误**
- **现象**：预期0x0000ABCD，实际0x00001234
- **原因**：SH只存储wdata_ext低16位，wdata_ext = {16'b0, wdata_i[15:0]}
- **解决**：修正测试预期值为0x00001234

**问题3：LH符号扩展计算**
- **现象**：预期0xFFFFF800，实际0xFFFF8000
- **原因**：wdata_ext = 0x00008000，LH读取0x8000符号扩展为0xFFFF8000
- **解决**：修正预期值为0xFFFF8000

**问题4：字地址冲突**
- **现象**：测试6/7/8地址0x18/0x1A覆盖同一字
- **解决**：使用新地址0x24避免数据冲突

### 4.2 关键波形说明
- 字节写使能信号 `byte_we[3:0]` 正确控制写入位置
- 符号扩展 `{{24{rdata_raw[7]}}, rdata_raw[7:0]}` 正确处理负数字节

## 五、依赖关系

| 依赖项 | 状态 | 说明 |
|--------|------|------|
| Control.v mem_op_o | ⏳ 等待 | 需成员1定义MemOp信号 |
| EX_MEM_Reg.v mem_op | ⏳ 等待 | 需成员1添加mem_op传递 |
| ExtUnit.v | ⏳ 等待 | 成员2实现，不影响DM测试 |

## 六、下一步计划

- [ ] 集成DM.v到流水线
- [ ] 测试Trap_Detect + DM联合功能
- [ ] 开发EX_MEM_Reg.v mem_op传递（依赖成员1）
- [ ] 创建member3/1iteration3.md迭代报告

## 七、文件清单

```
member3/
├── 1iteration1.md          # Trap_Detect迭代报告
├── 1iteration2.md          # DM.v迭代报告
└── dm_waveform.vcd         # 调试波形（可选）
```

---

**版本**：v1.0
**日期**：2025-01-22
**状态**：已完成
