# 成员3与成员4对接规范

## 一、概述

### 1.1 对接目的

本文档描述成员3（访存扩展+自陷检测）需要与成员4（分支控制+CP0协处理器）进行接口对接的详细内容。成员3的 `Trap_Detect.v` 模块检测到的 SYSCALL/BREAK 异常需要传递给成员4的 `CP0_Reg.v` 进行异常处理。

### 1.2 对接范围

| 成员3任务 | 需要对接的内容 | 对接对象 |
|----------|----------------|----------|
| Trap_Detect.v | trap_type (异常类型) | CP0_Reg.v (Cause寄存器) |
| Trap_Detect.v | is_syscall/is_break | CP0_Reg.v (异常触发) |
| CP0_Reg.v | EPC计算 | 流水线 (PC保存) |

### 1.3 对接原则

1. **接口标准化**：所有信号命名遵循统一规范
2. **异常处理**：确保异常信号正确传递到CP0
3. **向后兼容**：不破坏现有非异常指令的功能
4. **文档先行**：接口确定后不允许单方面修改

---

## 二、接口定义

### 2.1 异常类型信号 trap_type[5:0]

**来源**：Trap_Detect.v (成员3实现)
**传递路径**：Trap_Detect → Control → CP0

```verilog
// Trap_Detect.v 输出接口（成员3完成）
output [5:0] trap_type      // 异常类型 -> Control/CP0
```

### 2.2 trap_type 编码定义 (MIPS标准)

| trap_type | 名称 | 说明 | 来源 |
|-----------|------|------|------|
| 6'd0 | None | 无异常 | - |
| 6'd8 | Sys | 系统调用异常 | SYSCALL |
| 6'd9 | Bp | 断点异常 | BREAK |

### 2.3 异常检测信号

```verilog
// Trap_Detect.v 输出接口（成员3完成）
output       is_syscall,    // SYSCALL检测 -> Control
output       is_break,      // BREAK检测 -> Control
```

---

## 三、CP0 协处理器接口

### 3.1 成员4需实现的模块

```verilog
// ========== CP0_Reg.v ==========
module CP0_Reg (
    // 时钟复位
    input         clk,
    input         rst,

    // 读写接口
    input         we,          // 写使能 <- MTC0
    input  [4:0]  addr,        // 寄存器地址
    input  [31:0] wdata,       // 写入数据

    // 异常处理接口
    input         eret,        // ERET信号 <- Control
    input  [31:0] epc_i,       // EPC输入 <- 流水线
    input  [5:0]  cause_i,     // 异常原因 <- Trap_Detect (通过Control)
    input         syscall_i,   // SYSCALL <- Trap_Detect
    input         break_i,     // BREAK <- Trap_Detect

    // 输出接口
    output [31:0] rdata,       // 读取数据 -> MFC0
    output [31:0] epc_o,       // EPC输出 -> PC_Mux
    output [4:0]  cause_o,     // 异常原因输出
    output        exception_o  // 异常发生信号 -> 流水线
);
```

### 3.2 CP0 寄存器地址

| 地址 | 寄存器 | 读写 | 说明 |
|------|--------|------|------|
| 8 | BadVAddr | 只读 | 错误地址 |
| 9 | Count | 读写 | 计数器 |
| 12 | Status | 读写 | 状态寄存器 |
| 13 | Cause | 只写 | 异常原因 |
| 14 | EPC | 读写 | 异常程序计数器 |

### 3.3 成员4需实现的异常处理逻辑

```verilog
// CP0_Reg.v 内部逻辑框架
module CP0_Reg (
    input         clk,
    input         rst,
    input         we,
    input  [4:0]  addr,
    input  [31:0] wdata,
    input         eret,
    input  [31:0] epc_i,
    input  [5:0]  cause_i,
    input         syscall_i,
    input         break_i,
    output [31:0] rdata,
    output [31:0] epc_o,
    output [4:0]  cause_o,
    output        exception_o
);

    // 异常发生条件
    wire exception = syscall_i || break_i;

    // 异常类型设置
    wire [5:0] trap_cause = syscall_i ? 6'd8 :  // Sys
                           break_i  ? 6'd9 :    // Bp
                           cause_i;              // 其他

    // EPC寄存器
    reg [31:0] epc_reg;
    always @(posedge clk or posedge rst) begin
        if (rst) begin
            epc_reg <= 32'd0;
        end else if (exception) begin
            epc_reg <= epc_i;  // 保存异常指令地址
        end else if (we && addr == 5'd14) begin
            epc_reg <= wdata;  // 手动写EPC
        end
    end

    // Cause寄存器
    reg [31:0] cause_reg;
    always @(posedge clk or posedge rst) begin
        if (rst) begin
            cause_reg <= 32'd0;
        end else if (exception) begin
            cause_reg <= {26'd0, trap_cause, 5'd0};
        end else if (we && addr == 5'd13) begin
            cause_reg <= wdata;
        end
    end

    // 输出
    assign epc_o = epc_reg;
    assign cause_o = cause_reg[9:4];  // ExcCode字段
    assign exception_o = exception;

endmodule
```

---

## 四、异常处理流程

### 4.1 异常检测时序

```
clk    ─┐  ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐
        └──┘  └──┘ └──┘ └──┘ └──┘ └──┘

IF     [SYSCALL] ────────────────────────────────────────
ID            └── Trap_Detect检测
                         └── syscall_o=1 ──► Control
EX          ┌─────────► exception_o=1 ──► CP0
            │                    └── EPC = PC
MEM         └─────────► 保存EPC ──► 异常处理完成

ERET时序：
IF     [ERET] ───────────────────────────────────────────
ID            └── eret_o=1 ──► CP0
EX         ┌─────────► PC = EPC
MEM        │
WB         │
```

### 4.2 异常处理数据流

```
                    ┌─────────────────────────────────────┐
                    │         异常处理数据流              │
    ┌───────────────┼─────────────────────────────────────┼───────────────┐
    │               │                                     │               │
    │   Trap_Detect │                                     │   CP0_Reg     │
    │   (成员3)     │                                     │   (成员4)     │
    │               │                                     │               │
    │  is_syscall ──┼──────► Control ─────────────────────┼──► exception  │
    │  is_break  ───┤           │                         │               │
    │  trap_type ───┴───────────┴─────────────────────────┼──► cause      │
    │                              │                      │               │
    │                              ▼                      │               │
    │                      ┌──────────────┐               │               │
    │                      │  流水线PC    │               │               │
    │                      │  (异常指令地址)├───────────────┼──► EPC       │
    │                      └──────────────┘               │               │
    │                                                     │               │
    │                      ┌──────────────┐               │               │
    │                      │  PC_Mux      │               │               │
    │                      │  (异常返回)  │◄──────────────┼─── EPC       │
    │                      └──────────────┘               │               │
    └─────────────────────────────────────────────────────┴───────────────┘
```

---

## 五、信号汇总表

### 5.1 模块间接口

| 模块 | 输入信号 | 输出信号 | 对接模块 |
|------|----------|----------|----------|
| Trap_Detect | instr | is_syscall, is_break, trap_type | Control |
| Control | syscall_i, break_i | exception_o, eret_o | Trap_Detect, CP0 |
| CP0_Reg | syscall_i, break_i, epc_i | exception_o, epc_o, cause_o | Control, Datapath |
| Datapath | - | current_pc | CP0 |

### 5.2 信号位宽

| 信号名 | 位宽 | 说明 |
|--------|------|------|
| is_syscall | 1 | SYSCALL检测信号 |
| is_break | 1 | BREAK检测信号 |
| trap_type | [5:0] | 异常类型编码 |
| cause_i | [5:0] | 异常原因输入 |
| exception_o | 1 | 异常发生信号 |
| epc_i/o | [31:0] | 异常程序计数器 |

---

## 六、集成检查清单

### 6.1 成员3需完成

- [ ] Trap_Detect.v（✅ 已完成）
- [ ] Trap_Detect.v 连接到 Control.v
- [ ] 提供 trap_type 给 Control.v

### 6.2 成员4需完成

- [ ] CP0_Reg.v 实现
- [ ] CP0_Reg.v 异常检测逻辑
- [ ] CP0_Reg.v ERET 指令实现
- [ ] PC_Mux.v 添加 EPC 选择

### 6.3 集成验证

- [ ] SYSCALL 触发异常，EPC正确保存
- [ ] BREAK 触发异常，EPC正确保存
- [ ] ERET 正确返回异常前PC
- [ ] MFC0/MTCO 正常工作

---

## 七、注意事项

### 7.1 接口稳定性

1. **接口确定后禁止单方面修改**：如需修改接口，需经双方协商
2. **版本管理**：接口变更需更新本文档版本号
3. **同步机制**：每周同步会议确认接口状态

### 7.2 时序要求

1. **异常信号同步**：Trap_Detect检测信号需与流水线同步
2. **EPC保存时机**：在异常发生周期保存PC
3. **ERET恢复**：ERET信号有效时PC选择EPC

### 7.3 兼容性

1. **向后兼容**：异常处理不影响非异常指令
2. **异常隔离**：异常指令不改变处理器状态

---

## 八、特权指令编码参考

### 8.1 SYSCALL

| 字段 | 值 |
|------|-----|
| opcode | 6'b000000 |
| rs | 5'b00000 |
| rt | 5'b00000 |
| rd | 5'b00000 |
| shamt | 5'b00000 |
| funct | 6'b001100 |

### 8.2 BREAK

| 字段 | 值 |
|------|-----|
| opcode | 6'b000000 |
| rs | 5'b00000 |
| rt | 5'b00000 |
| rd | 5'b00000 |
| shamt | 5'b00000 |
| funct | 6'b001101 |

### 8.3 ERET

| 字段 | 值 |
|------|-----|
| 全字 | 32'b01000010000000000000000000011000 |

### 8.4 MFC0

| 字段 | 值 |
|------|-----|
| opcode | 6'b010000 |
| rs | 5'b00000 |
| rt | 目标寄存器 |
| rd | CP0寄存器 |
| funct | - |

### 8.5 MTC0

| 字段 | 值 |
|------|-----|
| opcode | 6'b010000 |
| rs | 5'b00100 |
| rt | 源寄存器 |
| rd | CP0寄存器 |
| funct | - |

---

## 九、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-22 | 初始版本 | 成员3 |

---

**文档版本**：v1.0
**创建日期**：2025年1月22日
**所属成员**：成员3
**对接对象**：成员4
