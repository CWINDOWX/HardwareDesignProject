# 成员3与成员4对接规范 (v1.1)

## 一、概述

### 1.1 对接目的

本文档描述成员3（访存扩展+自陷检测）与成员4（分支控制+CP0协处理器）之间的接口对接。成员3的模块需要与成员4的CP0_Reg.v进行异常处理的协作。

### 1.2 成员3实现的模块

| 模块 | 功能 | 状态 |
|------|------|------|
| DM.v | 数据存储器，支持字节/半字/字访存 | 已完成 |
| ExtUnit.v | 立即数扩展单元 | 已完成 |
| Trap_Detect.v | 自陷检测（SYSCALL/BREAK） | 已完成 |
| CP0_Reg.v | CP0协处理器（EPC, Cause, Status等） | 已完成 |

### 1.3 对接范围

| 成员3任务 | 需要对接的内容 | 对接对象 |
|----------|----------------|----------|
| Trap_Detect.v | is_syscall, is_break | Control.v (成员1) |
| CP0_Reg.v | EPC, Cause, exception_o | 流水线/PC选择器 |

---

## 二、DM.v 接口（成员3实现）

### 2.1 模块接口

```verilog
module DM (
    input         clk,
    input         rst,
    input  [31:0] addr_i,       // 访存地址
    input  [31:0] wdata_i,      // 写入数据
    input         we_i,         // 写使能
    input  [2:0]  mem_op_i,     // 访存操作类型 <- Control
    output [31:0] rdata_o       // 读取数据 -> 流水线
);
```

### 2.2 mem_op_i 编码定义

| mem_op_i | 访存指令 | 操作 | 说明 |
|----------|----------|------|------|
| 3'b000 | LW/SW | 字(4字节) | 默认字访问 |
| 3'b001 | SH | 半字存储 | 写半字 |
| 3'b010 | SB | 字节存储 | 写字节 |
| 3'b100 | LH | 半字符号扩展 | 读半字符号扩展 |
| 3'b101 | LHU | 半字零扩展 | 读半字零扩展 |
| 3'b110 | LB | 字节符号扩展 | 读字节符号扩展 |
| 3'b111 | LBU | 字节零扩展 | 读字节零扩展 |

**当前实现状态**：已完成

---

## 三、ExtUnit.v 接口（成员3实现）

### 3.1 模块接口

```verilog
module ExtUnit (
    input  [15:0] imm,        // 16位立即数 <- 指令
    input  [1:0]  ext_type_i, // 扩展类型 <- Control
    output [31:0] ext_result  // 32位扩展结果 -> datapath
);
```

### 3.2 ext_type_i 编码定义

| ext_type_i | 用途 | 扩展方式 | 对应指令 |
|------------|------|----------|----------|
| 2'b00 | 默认符号扩展 | 符号扩展 | LW, SW, BEQ, ADDI, ADDIU, SLTI |
| 2'b01 | 零扩展 | 零扩展 | ANDI, ORI, XORI |
| 2'b10 | Load符号扩展 | 符号扩展 | LB, LH |
| 2'b11 | Load零扩展 | 零扩展 | LBU, LHU |

**当前实现状态**：已完成

---

## 四、Trap_Detect.v 接口（成员3实现）

### 4.1 模块接口

```verilog
module Trap_Detect (
    input  [31:0] instr,        // 当前指令 <- IF阶段
    output       is_syscall,    // SYSCALL检测 -> Control
    output       is_break,      // BREAK检测 -> Control
    output [5:0] trap_type      // 异常类型 (暂未使用)
);
```

### 4.2 异常检测逻辑

```verilog
assign is_syscall = (instr == 32'b000000000000000000000000001100); // SYSCALL
assign is_break   = (instr == 32'b000000000000000000000000001101); // BREAK
assign trap_type  = is_syscall ? 6'd8 : is_break ? 6'd9 : 6'd0;
```

**当前实现状态**：已完成，已集成到mips.v

---

## 五、CP0_Reg.v 接口（成员3实现）

### 5.1 模块接口

```verilog
module CP0_Reg (
    input         clk, rst,
    // MTC0/MFC0
    input         we,          // 写使能
    input  [4:0]  addr,        // 寄存器地址
    input  [31:0] wdata,       // 写入数据
    output reg [31:0] rdata,   // 读取数据
    // 异常处理
    input         eret,        // ERET指令
    input  [31:0] epc_i,       // EPC输入 (异常指令地址)
    input  [5:0]  cause_i,     // 异常原因
    input         syscall_i,   // SYSCALL
    input         break_i,     // BREAK
    // 输出
    output [31:0] epc_o,       // EPC输出
    output [5:0]  cause_o,     // 异常原因输出 (ExcCode)
    output        exception_o  // 异常发生信号
);
```

### 5.2 CP0寄存器地址

| 地址 | 寄存器 | 读写 | 说明 |
|------|--------|------|------|
| 5'd8 | BadVAddr | 只读 | 错误虚拟地址 |
| 5'd9 | Count | 读写 | 计数器 |
| 5'd12 | Status | 读写 | 状态寄存器 |
| 5'd13 | Cause | 只写 | 异常原因 |
| 5'd14 | EPC | 读写 | 异常程序计数器 |

### 5.3 异常编码 (ExcCode)

| ExcCode | 名称 | 说明 |
|---------|------|------|
| 6'd0 | Int | 中断 |
| 6'd1 | Mod | TLB修改异常 |
| 6'd2 | TLBL | TLB读异常 |
| 6'd3 | TLBS | TLB存储异常 |
| 6'd4 | AdEL | 地址错误读 |
| 6'd5 | AdES | 地址错误存储 |
| 6'd8 | Sys | 系统调用 |
| 6'd9 | Bp | 断点 |
| 6'd10 | RI | 保留指令 |
| 6'd11 | CpU | 协处理器不可用 |
| 6'd12 | Ov | 溢出 |

**当前实现状态**：已完成

---

## 六、异常处理流程

### 6.1 异常检测时序

```
IF     [SYSCALL/BREAK] ──────────────────────────────────────────
ID            └── Trap_Detect检测
                      └── syscall_i/break_i=1 ──► Control
EX           ┌─────────► exception_o=1 ──► datapath/CP0
             │                    └── EPC = PC(异常指令地址)
MEM          └─────────► 保存EPC ──► 异常处理完成
```

### 6.2 ERET返回时序

```
IF     [ERET] ───────────────────────────────────────────────────
ID            └── eret_o=1 ──► CP0
EX         ┌─────────► PC = EPC_o
MEM        │
WB         │
```

---

## 七、集成检查清单

### 7.1 成员3已完成

- [x] DM.v - 支持字节/半字/字访存
- [x] ExtUnit.v - 支持符号/零扩展
- [x] CP0_Reg.v - 异常处理和EPC/Status/Cause寄存器
- [x] Trap_Detect.v - SYSCALL/BREAK检测
- [x] mips.v集成Trap_Detect
- [x] controller.v集成异常信号 (syscall_i, break_i, exception_o, cause_o)

### 7.2 需要成员4完成

- [ ] CP0_Reg.v 集成到mips.v (目前由成员3实现，可直接使用)
- [ ] PC_Mux.v 添加EPC选择支持 (eret_o有效时选择EPC)
- [ ] 异常时PC跳转到异常处理入口

### 7.3 集成验证

- [x] SYSCALL 触发异常
- [x] BREAK 触发异常
- [ ] ERET 正确返回
- [ ] LW/SW 正常工作
- [ ] LB/LBU/LH/LHU/SB/SH 正常工作

---

## 八、接口信号汇总

### 8.1 Control → 成员3模块

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| mem_op_o | [2:0] | Control→DM | 访存操作类型 |
| ext_type_o | [1:0] | Control→ExtUnit | 立即数扩展类型 |

### 8.2 Trap_Detect → Control

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| is_syscall | 1 | Trap→Control | SYSCALL检测 |
| is_break | 1 | Trap→Control | BREAK检测 |

### 8.3 Control/CP0 输出

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| exception_o | 1 | Control→Datapath | 异常发生 |
| cause_o | [5:0] | Control→CP0 | 异常原因 |
| eret_o | 1 | Control→CP0 | ERET指令 |

---

## 九、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-22 | 初始版本 | 成员3 |
| v1.1 | 2026-01-26 | 更新为实际实现状态，添加DM/ExtUnit接口 | 成员3 |

---

**文档版本**：v1.1
**创建日期**：2025-01-22
**最后更新**：2026-01-26
**所属成员**：成员3
**对接对象**：成员4
