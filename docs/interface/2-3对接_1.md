# 成员3与成员2对接规范

## 一、概述

### 1.1 对接目的

本文档描述成员3（访存扩展+自陷检测）需要与成员2（移位单元+扩展单元）进行接口对接的详细内容。成员2负责 `ExtUnit.v` 的实现，成员3的 LB/LBU/LH/LHU 访存指令需要使用 ExtUnit 进行零扩展/符号扩展。

### 1.2 对接范围

| 成员3任务 | 需要对接的内容 | 对接对象 |
|----------|----------------|----------|
| LB/LH | 访存地址计算 | ExtUnit (符号扩展) |
| LBU/LHU | 访存地址计算 | ExtUnit (零扩展) |
| SB/SH | 访存地址计算 | ExtUnit (符号扩展) |

### 1.3 对接原则

1. **接口标准化**：所有信号命名遵循统一规范
2. **时序对齐**：确保扩展信号与访存操作同步
3. **向后兼容**：不破坏现有LW/SW的功能
4. **文档先行**：接口确定后不允许单方面修改

---

## 二、接口定义

### 2.1 扩展类型信号 ExtType[1:0]

**来源**：Control.v (由成员1管理)
**传递路径**：Control → ID_EX_Reg → ExtUnit

```verilog
// ID_EX_Reg.v 中新增（成员1实现）
input  [1:0] ext_type_i,   // <- Control
output [1:0] ext_type_o    // -> ExtUnit
```

### 2.2 ExtType 编码定义

| ext_type_o | 用途 | 扩展方式 | 成员3对应指令 |
|------------|------|----------|---------------|
| 2'b00 | 默认 | 符号扩展 | LW, SW, BEQ, ADDI |
| 2'b01 | 零扩展 | 零扩展 | ANDI, ORI, XORI |
| 2'b10 | Load符号扩展 | 符号扩展 | LB, LH |
| 2'b11 | Load零扩展 | 零扩展 | LBU, LHU |

### 2.3 成员3需要的扩展类型

| 指令 | opcode | ext_type_o | 扩展方式 |
|------|--------|------------|----------|
| LB | 6'b100000 | 2'b10 | 符号扩展 (地址偏移) |
| LBU | 6'b100100 | 2'b11 | 零扩展 (地址偏移) |
| LH | 6'b100001 | 2'b10 | 符号扩展 (地址偏移) |
| LHU | 6'b100101 | 2'b11 | 零扩展 (地址偏移) |
| SB | 6'b101000 | 2'b00 | 符号扩展 (地址偏移) |
| SH | 6'b101001 | 2'b00 | 符号扩展 (地址偏移) |

---

## 三、ExtUnit 模块接口

### 3.1 成员2需实现的模块

```verilog
// ========== ExtUnit.v ==========
module ExtUnit (
    input  [15:0] imm,       // 16位立即数 <- 指令
    input  [1:0]  ext_type_i, // 扩展类型 <- ID_EX_Reg
    output [31:0] ext_result  // 32位扩展结果 -> ID阶段
);
```

### 3.2 ExtUnit 内部逻辑

```verilog
// ExtUnit.v 内部逻辑
module ExtUnit (
    input  [15:0] imm,
    input  [1:0]  ext_type,
    output [31:0] ext_result
);

    // 扩展类型：
    // 00: 符号扩展 (默认)
    // 01: 零扩展 (ANDI/ORI/XORI)
    // 10: 符号扩展 (LB/LH)
    // 11: 零扩展 (LBU/LHU)

    assign ext_result = (ext_type == 2'b00) ? {{16{imm[15]}}, imm} :  // 符号扩展
                        (ext_type == 2'b01) ? {16'b0, imm} :          // 零扩展
                        (ext_type == 2'b10) ? {{16{imm[15]}}, imm} :  // 符号扩展
                        {16'b0, imm};                                 // 零扩展

endmodule
```

### 3.3 成员2需修改的流水线寄存器

```verilog
// ========== ID_EX_Reg.v ==========
module ID_EX_Reg (
    // ... 现有端口 ...

    // 新增：扩展类型信号
    input  [1:0]  ext_type_i,   // <- Control.v
    output reg [1:0] ext_type_o  // -> ExtUnit.v
);
```

---

## 四、数据通路连接

### 4.1 ID阶段连接图

```
                    ┌─────────────────────────────────────┐
                    │            ID 阶段                  │
    ┌──────────┐    │    ┌──────────┐                    │
    │  IF_ID   │───►│    │ ExtUnit  │───► 立即数扩展结果  │
    │  Reg     │    │    │ (成员2)  │                    │
    │  (imm)   │    │    └──────────┘                    │
    └──────────┘    │           ▲                        │
                    │           │ ext_type_o             │
                    │    ┌──────┴──────┐                 │
                    │    │  ID_EX_Reg  │                 │
                    │    │  ext_type   │                 │
                    │    └─────────────┘                 │
                    └─────────────────────────────────────┘
```

### 4.2 访存指令地址计算

```
        ┌────────────────────────────────────────────────────────┐
        │                    EX 阶段                             │
        │    ┌─────────────────────────────────────┐             │
        │    │            ALU                      │             │
        │    │   rs_data + ext_result (访存地址)   │             │
        │    └─────────────────────────────────────┘             │
        │                    │                                    │
        │                    ▼                                    │
        │    ┌─────────────────────────────────────┐             │
        │    │            EX_MEM_Reg               │             │
        │    │         mem_op_o / addr_o           │             │
        │    └─────────────────────────────────────┘             │
        │                    │                                    │
        │                    ▼                                    │
        │    ┌─────────────────────────────────────┐             │
        │    │              DM.v                   │             │
        │    │         (成员3 - 访存执行)          │             │
        │    └─────────────────────────────────────┘             │
        └────────────────────────────────────────────────────────┘
```

---

## 五、信号汇总表

### 5.1 模块间接口

| 模块 | 输入信号 | 输出信号 | 对接模块 |
|------|----------|----------|----------|
| Control.v | - | ext_type_o | ID_EX_Reg |
| ID_EX_Reg | ext_type_i | ext_type_o | Control, ExtUnit |
| ExtUnit | imm, ext_type_i | ext_result | ID_EX_Reg, datapath |
| Datapath | ext_result | - | ExtUnit |

### 5.2 信号位宽

| 信号名 | 位宽 | 说明 |
|--------|------|------|
| imm | [15:0] | 指令中的16位立即数 |
| ext_type_i/o | [1:0] | 扩展类型控制信号 |
| ext_result | [31:0] | 32位扩展结果 |

---

## 六、集成检查清单

### 6.1 成员2需完成

- [ ] ExtUnit.v 实现（支持4种扩展类型）
- [ ] ID_EX_Reg.v 添加 ext_type 传递
- [ ] Control.v 添加 ext_type_o 信号定义（由成员1实现）
- [ ] ExtUnit 独立测试

### 6.2 成员3需完成

- [ ] LB/LBU/LH/LHU 使用正确的 ext_type
- [ ] SB/SH 使用默认 ext_type
- [ ] DM.v 集成测试

### 6.3 集成验证

- [ ] LW 指令正常工作 (ext_type=00)
- [ ] SW 指令正常工作 (ext_type=00)
- [ ] LB/LH 指令正常工作 (ext_type=10)
- [ ] LBU/LHU 指令正常工作 (ext_type=11)
- [ ] ANDI/ORI/XORI 指令正常工作 (ext_type=01)

---

## 七、注意事项

### 7.1 接口稳定性

1. **接口确定后禁止单方面修改**：如需修改接口，需经双方协商
2. **版本管理**：接口变更需更新本文档版本号
3. **同步机制**：每周同步会议确认接口状态

### 7.2 时序要求

1. **ExtType信号提前有效**：确保ExtUnit能正确采样
2. **扩展结果与ALU同步**：地址计算需要在EX阶段完成

### 7.3 兼容性

1. **向后兼容**：新接口不影响现有LW/SW指令
2. **默认值**：ext_type默认值为2'b00（符号扩展）

---

## 八、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-22 | 初始版本 | 成员3 |

---

**文档版本**：v1.0
**创建日期**：2025年1月22日
**所属成员**：成员3
**对接对象**：成员2
