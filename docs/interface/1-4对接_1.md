# 成员1与成员4对接规范

## 一、概述

### 1.1 对接目的

本文档定义成员1（Control.v管理者）与成员4（Branch_Cmp.v, CP0_Reg集成）之间的接口对接。成员1需要向成员4提供控制信号，成员4的模块输出需要反馈给成员1。

### 1.2 对接范围

| 成员1提供 | 成员4使用 | 说明 |
|-----------|-----------|------|
| branch_o | Branch_Cmp | 分支使能 |
| eret_o | CP0_Reg | 异常返回 |
| cause_o | CP0_Reg | 异常原因 |

---

## 二、接口定义

### 2.1 branch_o - 分支控制信号

**来源**：controller.v (成员1实现)
**传递路径**：Control → datapath

```verilog
// controller.v 新增输出（成员1实现）
output wire branch_o,     // -> datapath: 分支使能
```

**分支指令编码**：

| 指令 | opcode | 条件 |
|------|--------|------|
| BEQ | 6'b000100 | rs == rt |
| BNE | 6'b000101 | rs != rt |
| BLEZ | 6'b000110 | rs <= 0 |
| BGTZ | 6'b000111 | rs > 0 |
| BLTZ | 6'b000001 | rs < 0 |
| BGEZ | 6'b000001 | rs >= 0 |

### 2.2 eret_o - 异常返回信号

**来源**：controller.v (成员1实现)
**传递路径**：Control → CP0_Reg → datapath

```verilog
// controller.v 新增输出（成员1实现）
output wire eret_o,       // -> CP0_Reg: ERET指令
```

**ERET指令编码**：

| 字段 | 值 |
|------|-----|
| opcode | 6'b010000 (COP1) |
| rs | 5'b10000 (16) |
| funct | 6'b011000 (24) |
| 全字 | 32'b01000010000000000000000000011000 |

### 2.3 cause_o[5:0] - 异常原因

**来源**：controller.v (成员1实现)
**传递路径**：Control → CP0_Reg

```verilog
// controller.v 新增输出（成员1实现）
output [5:0] cause_o,     // -> CP0_Reg: 异常原因
```

**异常类型编码 (ExcCode)**：

| cause_o | 名称 | 说明 | 来源 |
|---------|------|------|------|
| 6'd0 | Int | 中断 | - |
| 6'd4 | AdEL | 取指地址错 | - |
| 6'd5 | AdES | 存数地址错 | - |
| 6'd8 | Sys | 系统调用 | SYSCALL |
| 6'd9 | Bp | 断点 | BREAK |
| 6'd10 | RI | 保留指令 | - |
| 6'd12 | Ov | 溢出 | ADD/ADDI |

---

## 三、模块接口

### 3.1 Branch_Cmp.v 接口（成员4）

```verilog
module Branch_Cmp (
    input  [31:0] rs_data,     // <- 寄存器rs数据
    input  [31:0] rt_data,     // <- 寄存器rt数据
    input         branch_o,    // <- Control: 分支使能
    output        branch_taken // -> datapath: 分支发生
);
```

**分支比较逻辑**：

| 条件类型 | 指令 | 比较逻辑 |
|----------|------|----------|
| 等于 | BEQ | rs == rt |
| 不等 | BNE | rs != rt |
| 小于等于零 | BLEZ | rs <= 0 |
| 大于零 | BGTZ | rs > 0 |
| 小于零 | BLTZ | rs < 0 |
| 大于等于零 | BGEZ | rs >= 0 |

### 3.2 CP0_Reg.v 接口（成员3，已实现）

```verilog
module CP0_Reg (
    input         clk, rst,
    // 读写接口
    input         we, addr, wdata,
    output        rdata,
    // 异常处理
    input         eret,           <- controller: ERET
    input  [31:0] epc_i,
    input  [5:0]  cause_i,        <- controller: 异常原因
    input         syscall_i,      <- Trap_Detect
    input         break_i,        <- Trap_Detect
    // 输出
    output [31:0] epc_o,
    output [4:0]  cause_o,
    output        exception_o
);
```

---

## 四、异常处理流程

### 4.1 异常发生

```
SYSCALL/BREAK指令
        │
        ▼
  Trap_Detect 检测
        │
        ├── is_syscall=1 ──► controller
        └── is_break=1 ─────► controller
                                │
                                ▼
                      cause_o = 8 (Sys) 或 9 (Bp)
                                │
                                ▼
                      CP0_Reg 保存EPC和Cause
                                │
                                ▼
                      exception_o = 1
                                │
                                ▼
                      datapath 跳转到异常向量 0x80000180
```

### 4.2 异常返回

```
ERET指令
        │
        ▼
  controller 检测ERET
        │
        ▼
      eret_o = 1
        │
        ▼
   CP0_Reg 返回EPC
        │
        ▼
   datapath PC = EPC
```

---

## 五、信号汇总表

### 5.1 Controller输出（成员1→成员4）

| 信号 | 位宽 | 方向 | 目标模块 | 说明 |
|------|------|------|----------|------|
| branch_o | 1 | → | datapath | 分支使能 |
| eret_o | 1 | → | CP0_Reg | 异常返回 |
| cause_o | [5:0] | → | CP0_Reg | 异常原因 |

### 5.2 Controller输入（成员4→成员1）

| 信号 | 位宽 | 来源 | 说明 |
|------|------|------|------|
| branch_taken | 1 | Branch_Cmp | 分支发生 |
| exception_o | 1 | CP0_Reg | 异常发生 |

---

## 六、集成检查清单

### 6.1 成员1需完成

- [ ] controller.v 添加 branch_o 输出
- [ ] controller.v 添加 eret_o 输出
- [ ] controller.v 添加 cause_o 输出
- [ ] controller.v 添加 exception_i 输入
- [ ] controller.v 添加 branch_taken 输入
- [ ] datapath.v 实例化 Branch_Cmp

### 6.2 成员4需完成

- [ ] Branch_Cmp.v 实现
- [ ] Branch_Cmp.v 分支比较逻辑
- [ ] CP0_Reg.v 集成（成员3已实现）

### 6.3 集成验证

- [ ] BEQ/BNE 指令正常工作
- [ ] BLEZ/BGTZ 指令正常工作
- [ ] BLTZ/BGEZ 指令正常工作
- [ ] SYSCALL 触发异常
- [ ] BREAK 触发异常
- [ ] ERET 正确返回

---

## 七、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-25 | 初始版本 | 成员3 |

---

**文档版本**：v1.0
**创建日期**：2025-01-25
**所属成员**：成员3
**对接对象**：成员1, 成员4
