# 成员1与成员3对接规范 (v1.2)

## 一、概述

本文档定义成员1（Control.v管理者）与成员3（DM.v, Trap_Detect.v, ExtUnit.v, CP0_Reg.v）之间的接口对接。成员1需向成员3提供控制信号，成员3的模块输出需反馈给成员1。

## 二、接口定义

### 2.1 mem_op_o[2:0] - 访存操作类型

**来源**：controller.v (成员1实现)
**传递路径**：Control → EX_MEM_Reg → DM

**编码定义**：

| mem_op_o | 访存指令 | 操作 |
|----------|----------|------|
| 3'b000 | LW/SW | 字(4字节) |
| 3'b001 | SH | 半字存储 |
| 3'b010 | SB | 字节存储 |
| 3'b100 | LH | 半字符号扩展 |
| 3'b101 | LHU | 半字零扩展 |
| 3'b110 | LB | 字节符号扩展 |
| 3'b111 | LBU | 字节零扩展 |

**当前实现状态**：已添加 (v1.2)

### 2.2 ext_type_o[1:0] - 扩展类型

**来源**：controller.v (成员1实现)
**传递路径**：Control → ID_EX_Reg → ExtUnit

**编码定义**：

| ext_type_o | 用途 | 扩展方式 | 对应指令 |
|------------|------|----------|----------|
| 2'b00 | 默认符号扩展 | 符号扩展 | LW, SW, BEQ, ADDI, ADDIU, SLTI |
| 2'b01 | 零扩展 | 零扩展 | ANDI, ORI, XORI |
| 2'b10 | Load符号扩展 | 符号扩展 | LB, LH |
| 2'b11 | Load零扩展 | 零扩展 | LBU, LHU |

**当前实现状态**：已添加 (v1.2)

### 2.3 trap_type[5:0] - 异常类型

**来源**：Trap_Detect.v (成员3实现)
**传递路径**：Trap_Detect → Control

| trap_type | 名称 | ExcCode | 说明 |
|-----------|------|---------|------|
| 6'd0 | None | - | 无异常 |
| 6'd8 | Sys | 8 | SYSCALL异常 |
| 6'd9 | Bp | 9 | BREAK异常 |

### 2.4 exception_o - 异常发生信号

**来源**：controller.v / CP0_Reg.v
**传递路径**：Control → datapath

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| exception_o | 1 | Control→datapath | 异常发生 |

**当前实现状态**：已添加 (v1.2)

### 2.5 eret_o - ERET指令信号

**来源**：controller.v (暂未实现)
**传递路径**：Control → CP0_Reg

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| eret_o | 1 | Control→CP0_Reg | ERET指令 (返回异常) |

**当前实现状态**：已添加，占时为0

### 2.6 cause_o[5:0] - 异常原因

**来源**：controller.v / CP0_Reg.v
**传递路径**：Control → CP0_Reg

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| cause_o | [5:0] | Control→CP0_Reg | 异常原因编码 |

**当前实现状态**：已添加 (v1.2)

---

## 三、模块接口

### 3.1 controller.v 接口（成员1）

```verilog
module controller(
    input wire clk,rst,
    //decode stage
    input wire[5:0] opD,functD,
    output wire pcsrcD,branchD,equalD,jumpD,

    //execute stage
    input wire flushE,
    output wire memtoregE,alusrcE,
    output wire regdstE,regwriteE,
    output wire[2:0] alucontrolE,
    output wire hassignE,
    output wire [1:0] hilo_enE,
    output wire [1:0] hilo_mfE,
    output wire divE,        // 除法指令标志

    //mem stage
    output wire memtoregM,memwriteM,
    output wire regwriteM,
    //write back stage
    output wire memtoregW,regwriteW,

    // ========== 成员3接口 ==========
    output wire [2:0] mem_op_o,     // -> DM
    output wire [1:0] ext_type_o,   // -> ExtUnit
    input  wire syscall_i,          // <- Trap_Detect
    input  wire break_i,            // <- Trap_Detect
    output wire exception_o,        // -> datapath/CP0_Reg
    output wire eret_o,             // -> CP0_Reg
    output wire [5:0] cause_o       // -> CP0_Reg
);
```

### 3.2 datapath.v 接口（成员1→成员3扩展）

```verilog
module datapath(
    // ... 原有接口 ...
    input wire divE,        // 除法指令标志 (成员1)

    // ========== 成员3接口 (未来扩展) ==========
    input wire [2:0] mem_op_i,     // 访存操作类型 <- Control
    input wire [1:0] ext_type_i,   // 立即数扩展类型 <- Control
    input wire exception_i         // 异常发生 <- Control
);
```

### 3.3 DM.v 接口（成员3）

```verilog
module DM (
    input         clk,
    input         rst,
    input  [31:0] addr_i,       // 访存地址
    input  [31:0] wdata_i,      // 写入数据
    input         we_i,         // 写使能
    input  [2:0]  mem_op_i,     // 访存操作类型
    output [31:0] rdata_o       // 读出数据
);
```

### 3.4 ExtUnit.v 接口（成员3）

```verilog
module ExtUnit (
    input  [15:0] imm,        // 16位立即数
    input  [1:0]  ext_type_i, // 扩展类型
    output [31:0] ext_result  // 扩展后结果
);
```

### 3.5 Trap_Detect.v 接口（成员3）

```verilog
module Trap_Detect (
    input  [31:0] instr,        // 当前指令
    output       is_syscall,    // SYSCALL检测
    output       is_break,      // BREAK检测
    output [5:0] trap_type      // 异常类型
);
```

### 3.6 CP0_Reg.v 接口（成员3）

```verilog
module CP0_Reg (
    input         clk, rst,
    // MTC0/MFC0
    input         we,
    input  [4:0]  addr,
    input  [31:0] wdata,
    output reg [31:0] rdata,
    // 异常处理
    input         eret,        // ERET指令
    input  [31:0] epc_i,       // EPC输入
    input  [5:0]  cause_i,     // 异常原因
    input         syscall_i,   // SYSCALL
    input         break_i,     // BREAK
    // 输出
    output [31:0] epc_o,       // EPC输出
    output [5:0]  cause_o,     // 异常原因输出
    output        exception_o  // 异常发生
);
```

---

## 四、流水线寄存器修改

### 4.1 EX_MEM_Reg.v - 添加mem_op传递

```verilog
// 新增端口
input  [2:0] mem_op_i,   // <- Control
output reg [2:0] mem_op_o // -> DM
```

### 4.2 ID_EX_Reg.v - 添加ext_type传递

```verilog
// 新增端口
input  [1:0] ext_type_i, // <- Control
output reg [1:0] ext_type_o // -> ExtUnit
```

---

## 五、异常处理流程

```
异常检测时序：

IF     [SYSCALL] ────────────────────────────────────────
ID            └── Trap_Detect检测
                         └── syscall_i=1 ──► Control
EX          ┌─────────► exception_o=1 ──► datapath
            │                    └── EPC = PC
MEM         └─────────► 保存EPC ──► 异常处理完成
```

---

## 六、集成检查清单

### 6.1 成员1需完成

- [x] controller.v 添加 mem_op_o[2:0] 输出
- [x] controller.v 添加 ext_type_o[1:0] 输出
- [x] controller.v 添加 syscall_i, break_i 输入
- [x] controller.v 添加 exception_o, eret_o, cause_o 输出
- [x] controller.v 添加 divE 输出
- [x] datapath.v 添加 divE 输入
- [x] hazard.v 添加 divE, divbusyE 支持
- [ ] EX_MEM_Reg.v 添加 mem_op 传递
- [ ] ID_EX_Reg.v 添加 ext_type 传递
- [ ] datapath.v 实例化 DM, ExtUnit

### 6.2 成员3需完成

- [x] DM.v 实现
- [x] ExtUnit.v 实现
- [x] CP0_Reg.v 实现
- [x] Trap_Detect.v 实现
- [x] mips.v 集成 Trap_Detect

### 6.3 集成验证

- [ ] LW/SW 指令正常工作
- [ ] LB/LBU/LH/LHU 指令正常工作
- [ ] SB/SH 指令正常工作
- [ ] SYSCALL 触发异常
- [ ] BREAK 触发异常
- [ ] ERET 正确返回

---

## 七、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-22 | 初始版本 | 成员3 |
| v1.1 | 2025-01-25 | 添加异常处理信号 | 成员3 |
| v1.2 | 2026-01-26 | 添加divE接口，更新实际实现 | 成员3 |

---

**文档版本**：v1.2
**创建日期**：2025-01-22
**最后更新**：2026-01-26
**所属成员**：成员3
**对接对象**：成员1
