# 成员1与成员3对接规范

## 一、概述

### 1.1 对接目的

本文档定义成员1（Control.v管理者）与成员3（DM.v, Trap_Detect.v, ExtUnit.v, CP0_Reg.v）之间的接口对接。成员1需向成员3提供控制信号，成员3的模块输出需反馈给成员1。

### 1.2 对接范围

| 成员1提供 | 成员3使用 | 说明 |
|-----------|-----------|------|
| mem_op_o | DM.mem_op_i | 访存操作类型 |
| ext_type_o | ExtUnit.ext_type_i | 扩展类型 |
| - | Trap_Detect.is_syscall | SYSCALL检测 |
| - | Trap_Detect.is_break | BREAK检测 |

### 1.3 对接原则

1. **接口标准化**：所有信号命名遵循统一规范（`_i`输入，`_o`输出）
2. **位宽明确**：所有信号有明确位宽
3. **默认值**：未使用信号有默认值

---

## 二、接口定义

### 2.1 mem_op_o[2:0] - 访存操作类型

**来源**：controller.v (成员1实现)
**传递路径**：Control → EX_MEM_Reg → DM

```verilog
// controller.v 新增输出（成员1实现）
output [2:0] mem_op_o,   // -> EX_MEM_Reg -> DM
```

**编码定义**：

| mem_op_o | 访存指令 | 操作 | 字节使能 |
|----------|----------|------|----------|
| 3'b000 | LW/SW | 字(4字节) | 4'b1111 |
| 3'b001 | SH | 半字存储 | addr[1]?4'b1100:4'b0011 |
| 3'b010 | SB | 字节存储 | 4'b0001 << addr[1:0] |
| 3'b100 | LH | 半字符号扩展 | - |
| 3'b101 | LHU | 半字零扩展 | - |
| 3'b110 | LB | 字节符号扩展 | - |
| 3'b111 | LBU | 字节零扩展 | - |

### 2.2 ext_type_o[1:0] - 扩展类型

**来源**：controller.v (成员1实现)
**传递路径**：Control → ID_EX_Reg → ExtUnit

```verilog
// controller.v 新增输出（成员1实现）
output [1:0] ext_type_o,  // -> ID_EX_Reg -> ExtUnit
```

**编码定义**：

| ext_type_o | 用途 | 扩展方式 | 对应指令 |
|------------|------|----------|----------|
| 2'b00 | 默认符号扩展 | 符号扩展 | LW, SW, BEQ, ADDI |
| 2'b01 | 零扩展 | 零扩展 | ANDI, ORI, XORI |
| 2'b10 | Load符号扩展 | 符号扩展 | LB, LH |
| 2'b11 | Load零扩展 | 零扩展 | LBU, LHU |

### 2.3 syscall_i / break_i - 自陷检测信号

**来源**：Trap_Detect.v (成员3实现)
**传递路径**：Trap_Detect → controller

```verilog
// controller.v 新增输入（成员1实现）
input  syscall_i,   // <- Trap_Detect: SYSCALL检测
input  break_i      // <- Trap_Detect: BREAK检测
```

**异常类型编码**：

| trap_type | 名称 | ExcCode | 指令 |
|-----------|------|---------|------|
| 6'd8 | Sys | 8 | SYSCALL |
| 6'd9 | Bp | 9 | BREAK |

### 2.4 exception_o / eret_o - 异常处理信号

**来源**：controller.v (成员1实现)
**传递给**：CP0_Reg, datapath

```verilog
// controller.v 新增输出（成员1实现）
output       exception_o,  // -> datapath: 异常发生
output       eret_o,       // -> CP0_Reg: ERET指令
output [5:0] cause_o       // -> CP0_Reg: 异常原因
```

---

## 三、模块接口

### 3.1 DM.v 接口（成员3）

```verilog
module DM (
    input         clk,
    input         rst,
    input  [31:0] addr_i,       // <- EX_MEM_Reg: 访存地址
    input  [31:0] wdata_i,      // <- datapath: 写入数据
    input         we_i,         <- memwriteM: 写使能
    input  [2:0]  mem_op_i,     <- EX_MEM_Reg: 访存操作
    output [31:0] rdata_o       -> datapath: 读出数据
);
```

### 3.2 ExtUnit.v 接口（成员3）

```verilog
module ExtUnit (
    input  [15:0] imm,        <- IF_ID: 指令立即数
    input  [1:0]  ext_type_i, <- ID_EX_Reg: 扩展类型
    output [31:0] ext_result  -> EX: 扩展后立即数
);
```

### 3.3 Trap_Detect.v 接口（成员3）

```verilog
module Trap_Detect (
    input  [31:0] instr,        <- IF_ID: 当前指令
    output       is_syscall,    -> controller: SYSCALL
    output       is_break,      -> controller: BREAK
    output [5:0] trap_type      -> controller: 异常类型
);
```

### 3.4 CP0_Reg.v 接口（成员3）

```verilog
module CP0_Reg (
    input         clk, rst,
    // MTC0/MFC0
    input         we, addr, wdata,
    output        rdata,
    // 异常处理
    input         eret,               <- controller: ERET
    input  [31:0] epc_i,              <- datapath: 异常PC
    input  [5:0]  cause_i,            <- controller: 异常原因
    input         syscall_i,          <- Trap_Detect
    input         break_i,            <- Trap_Detect
    // 输出
    output [31:0] epc_o,              -> datapath: EPC
    output [4:0]  cause_o,
    output        exception_o         -> datapath: 异常信号
);
```

---

## 四、流水线寄存器修改

### 4.1 EX_MEM_Reg.v - 添加mem_op传递

```verilog
// 新增端口
input  [2:0] mem_op_i,   // <- Control
output reg [2:0] mem_op_o // -> DM
```

### 4.2 ID_EX_Reg.v - 添加ext_type传递

```verilog
// 新增端口
input  [1:0] ext_type_i, // <- Control
output reg [1:0] ext_type_o // -> ExtUnit
```

---

## 五、数据通路连接

```
                    ┌─────────────────────────────────────┐
                    │           controller.v              │
                    │         (成员1 - 核心控制)          │
                    │                                     │
    ┌───────────────┼─────────────────────────────────────┼───────────────┐
    │               │                                     │               │
    │   Trap_Detect │                                     │   ExtUnit     │
    │   (成员3)     │                                     │   (成员3)     │
    │               │                                     │               │
    │  is_syscall ──┼────►┌──────────┐                   │               │
    │  is_break  ───┤      │Control   │                   │               │
    │               │      │   Logic  │                   │               │
    │               │      └────┬─────┘                   │               │
    │               │           │                         │               │
    │               │     ┌─────┴─────┐                   │               │
    │               │     │ mem_op_o  │                   │               │
    │               │     │ ext_type_o│                   │               │
    │               │     │ exception_o│                   │               │
    │               │     │ eret_o    │                   │               │
    │               │     └─────┬─────┘                   │               │
    │               │           │                         │               │
    └───────────────┼───────────┼─────────────────────────┼───────────────┘
                    │           │                         │
                    ▼           ▼                         ▼
    ┌───────────────────────┐ ┌───────────────────────┐
    │     ID_EX_Reg         │ │     EX_MEM_Reg        │
    │  ext_type_o ─────────►│ │  mem_op_o ──────────►│
    └───────────────────────┘ └───────────────────────┘
                    │                         │
                    ▼                         ▼
    ┌───────────────────────┐ ┌───────────────────────┐
    │     ExtUnit.v         │ │     DM.v              │
    │  ext_result ─────────►│ │  rdata_o ────────────┘
    └───────────────────────┘ └───────────────────────┘
```

---

## 六、信号汇总表

### 6.1 Control输出（成员1→成员3）

| 信号 | 位宽 | 方向 | 目标模块 | 说明 |
|------|------|------|----------|------|
| mem_op_o | [2:0] | → | EX_MEM_Reg | 访存操作类型 |
| ext_type_o | [1:0] | → | ID_EX_Reg | 扩展类型 |

### 6.2 Control输入（成员3→成员1）

| 信号 | 位宽 | 来源 | 说明 |
|------|------|------|------|
| syscall_i | 1 | Trap_Detect | SYSCALL检测 |
| break_i | 1 | Trap_Detect | BREAK检测 |
| exception_o | 1 | CP0_Reg | 异常发生信号 |

### 6.3 CP0_Reg输入（成员1→成员3）

| 信号 | 位宽 | 方向 | 说明 |
|------|------|------|------|
| eret | 1 | ← Control | ERET指令 |
| cause_i | [5:0] | ← Control | 异常原因 |

---

## 七、集成检查清单

### 7.1 成员1需完成

- [ ] controller.v 添加 mem_op_o[2:0] 输出
- [ ] controller.v 添加 ext_type_o[1:0] 输出
- [ ] controller.v 添加 syscall_i, break_i 输入
- [ ] controller.v 添加 exception_o, eret_o, cause_o 输出
- [ ] EX_MEM_Reg.v 添加 mem_op 传递
- [ ] ID_EX_Reg.v 添加 ext_type 传递
- [ ] datapath.v 实例化 DM, ExtUnit, CP0_Reg

### 7.2 成员3需完成

- [ ] DM.v 适配项目接口（已完成）
- [ ] ExtUnit.v 适配项目接口（已完成）
- [ ] CP0_Reg.v 适配项目接口（已完成）
- [ ] Trap_Detect.v 适配项目接口（已完成）

### 7.3 集成验证

- [ ] LW/SW 指令正常工作
- [ ] LB/LBU/LH/LHU 指令正常工作
- [ ] SB/SH 指令正常工作
- [ ] SYSCALL 触发异常
- [ ] BREAK 触发异常
- [ ] ERET 正确返回

---

## 八、版本记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-22 | 初始版本 | 成员3 |
| v1.1 | 2025-01-25 | 添加异常处理信号 | 成员3 |

---

**文档版本**：v1.1
**创建日期**：2025-01-22
**最后更新**：2025-01-25
**所属成员**：成员3
**对接对象**：成员1
